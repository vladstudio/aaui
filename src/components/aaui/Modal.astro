---
import {Theme, Transitions} from "./Theme.js"
import Button from "./Button.astro"
import {Icon} from "astro-icon/components"

const props = Astro.props
const is = props.is || "center" // center, left, right
delete props.is
const immediate = props.immediate || null
delete props.immediate

const layout =
  is == "left"
    ? "fixed top-0 bottom-0 left-0"
    : is == "right"
      ? "fixed top-0 bottom-0 right-0"
      : // center
        "mx-auto grid sm:mb-[20dvh]"

props.class = [
  Theme.modal.common,
  Theme.modal[is],
  "z-50 w-full",
  layout,
  props.class || "",
].join(" ")

const openImmediately = immediate
  ? {"x-data": "{ open: true }"}
  : {"x-data": "{ open: false }"}
---

<div
  {...openImmediately}
  x-id="['modal']"
  @keydown.escape.window.stop.prevent="$dispatch('modal', {id: $id('modal'), open: false})"
  @modal.window="if ($event.detail.id==$id('modal')) {open = $event.detail.open}">
  
  <!-- trigger -->
  {
    !immediate && (
      <span @click="$dispatch('modal', {id: $id('modal'), open: true})">
        <slot name="trigger" />
      </span>
    )
  }

  <template
    x-cloak
    x-teleport="body"
    @click="$dispatch('modal', {id: $id('modal'), open: false})">
    <!-- wrap -->
    <div
      class="fixed bottom-0 left-0 right-0 top-0 flex flex-col items-center justify-center p-2 sm:p-0"
      x-show="open">
      <!-- backdrop -->
      <div
        class={[
          Theme.backdrop,
          "fixed bottom-0 left-0 right-0 top-0 z-50",
        ].join(" ")}
        x-show="open"
        {...Transitions.backdrop}>
      </div>
      <!-- panel -->
      <div
        {...props}
        {...Transitions.modal[is]}
        :id="$id('modal')"
        @click.stop
        x-show="open"
        x-trap.inert.noscroll="open">
        <!-- header -->
        <div class="flex w-full items-center p-2">
          <div class="flex-1 pl-2">
            <slot name="title" />
          </div>
          <Button
            is="ghost"
            class="p-2"
            @click="$dispatch('modal', {id: $id('modal'), open: false})">
            <Icon name="ph:x-bold" size={16} class="text-stone-500" />
          </Button>
        </div>
        <!-- content -->
        <div class="p-2">
          <slot />
        </div>
      </div>
    </div>
  </template>
</div>
